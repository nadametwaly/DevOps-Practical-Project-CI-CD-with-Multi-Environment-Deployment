
- name: Deploy 3-Tier App with Docker & Ansible
  hosts: localhost
  become: yes
  vars_files:
    - vars/main.yml
  tasks:
    - name: Install dnf plugins core 
      dnf:
        name: dnf-plugins-core
        state: present

    - name: Add Docker CE repo
      yum_repository:
        name: docker-ce
        description: Docker CE Stable
        baseurl: https://download.docker.com/linux/centos/7/x86_64/stable
        gpgcheck: yes
        gpgkey: https://download.docker.com/linux/centos/gpg
        enabled: yes

    - name: Install Docker CE
      yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
          - docker-buildx-plugin
        state: present

    - name: Start Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Configure Docker DNS (fix network timeout issues)
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "dns": ["8.8.8.8", "8.8.4.4", "1.1.1.1"]
          }
        owner: root
        group: root
        mode: '0644'
      notify: restart docker

    - name: Ensure handlers run if needed
      meta: flush_handlers

    - name: Login to Docker Hub
      community.docker.docker_login:
        username: "{{ DOCKER_USERNAME }}"
        password: "{{ DOCKER_PASSWORD }}"

    - name: Create db_password.txt
      copy:
        dest: ./db_password.txt
        content: "{{ DB_PASSWORD }}"

    - name: Pull pre-built Docker images from Docker Hub
      community.docker.docker_image:
        name: "{{ item.name }}"
        tag: "{{ item.tag }}"
        source: pull
        state: present
      loop:
        - { name: "nadametwaly24/frontend-react", tag: "latest" }
        - { name: "nadametwaly24/backend-dotnet-api", tag: "latest" }
      retries: 3
      delay: 10
      register: pull_result

    - name: Display pulled images
      debug:
        msg: "Successfully pulled {{ item.item.name }}:{{ item.item.tag }}"
      loop: "{{ pull_result.results }}"
      when: item.changed

    - name: Deploy using Docker Compose
      community.docker.docker_compose_v2:
        project_src: "./"
        state: present

    - name: Wait for services to be healthy
      pause:
        seconds: 30

    - name: Verify running containers
      command: docker ps
      register: docker_ps_output

    - name: Display running containers
      debug:
        var: docker_ps_output.stdout_lines

    - name: Delete secret file after deployment
      file:
        path: ./db_password.txt
        state: absent

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted
